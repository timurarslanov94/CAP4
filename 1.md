 1. Проект использует современный Python стек с FastAPI,
  Dishka DI и asyncio для асинхронной обработки
  2. Архитектура следует принципам SOLID с разделением на
  слои: API, Services, Repositories, Models
  3. Поддерживаются два режима звонков: через SIP протокол
   и HTTP API Exolve
  ─────────────────────────────────────────────────

  Техническое задание: MVP голосового AI-агента

  Назначение системы

  Разработка голосового AI-агента для автоматизации
  телефонных звонков с использованием интеграции телефонии
   МТС Exolve и искусственного интеллекта ElevenLabs.

  Основные функциональные требования

  1. Инициация звонков

  - Система должна инициировать исходящие звонки на
  указанные номера телефонов
  - Поддержка двух режимов работы:
    - SIP протокол - прямое соединение через SIP с
  авторизацией
    - HTTP API Exolve - использование REST API для
  управления звонками
  - Выбор режима через конфигурацию (use_exolve_http)

  2. Обработка голосового потока

  - Получение аудио от абонента через RTP протокол (кодек
  PCMU/PCMA)
  - Конвертация аудио между форматами (8kHz для телефонии
  ↔ требуемый формат для AI)
  - Передача аудио в AI-агент ElevenLabs через WebSocket
  - Получение синтезированной речи от AI и отправка
  обратно абоненту

  3. AI-агент взаимодействие

  - Подключение к ElevenLabs Conversational AI через
  WebSocket
  - Передача аудио-потока от абонента в реальном времени
  - Получение ответов AI (текст + синтезированная речь)
  - Обработка транскрипций разговора

  4. Управление звонками

  - REST API для управления звонками:
    - POST /api/calls/start - начать новый звонок
    - POST /api/calls/hangup - завершить активный звонок
    - GET /api/calls - список всех звонков
    - GET /api/calls/{id} - информация о конкретном звонке

  5. Мониторинг и отладка

  - Эндпоинты для проверки состояния системы (/health)
  - Вебхуки для обработки событий от Exolve
  (/webhooks/exolve/callback)
  - Отладочные эндпоинты для тестирования компонентов

  Технические требования

  Архитектура

  - Микросервисная архитектура с разделением на слои
  - Dependency Injection через Dishka для управления
  зависимостями
  - Асинхронная обработка на базе asyncio
  - Repository pattern для работы с данными

  Компоненты системы

  1. API Layer - FastAPI эндпоинты
  2. Service Layer - бизнес-логика (CallService,
  AudioBridgeService, etc.)
  3. Repository Layer - хранение данных в памяти
  4. Infrastructure - DI контейнер, конфигурация

  Сетевые протоколы

  - SIP - для установления телефонных соединений
  - RTP - для передачи аудио в реальном времени
  - WebSocket - для связи с AI-агентом
  - HTTP/REST - для управления системой

  Поддержка прокси

  - Опциональная поддержка SOCKS5 прокси для исходящих
  соединений
  - Конфигурация через переменные окружения

  Конфигурация

  Система конфигурируется через переменные окружения (.env
   файл):
  - Учетные данные Exolve (API ключ, SIP логин/пароль)
  - Учетные данные ElevenLabs (API ключ, ID агента)
  - Сетевые настройки (порты для RTP, WebSocket, SIP)
  - Прокси настройки (опционально)

  Ограничения MVP

  - Хранение данных только в памяти (без БД)
  - Поддержка одновременно ограниченного числа звонков
  - Базовая обработка ошибок
  - Отсутствие аутентификации для API

  Дополнение к ТЗ: Механизмы подключения

  1. Подключение к МТС Exolve

  Вариант A: SIP протокол (основной)

  Процесс подключения:
  1. Инициализация клиента - получение локального IP
  адреса для NAT traversal
  2. Создание UDP сокета - привязка к порту в диапазоне
  5060-5080
  3. SIP регистрация:
    - Отправка REGISTER запроса на сервер
  80.75.130.100:5060
    - Получение 401 Unauthorized с challenge для
  аутентификации
    - Повторная отправка REGISTER с Digest авторизацией
  (MD5 хеш)
    - Получение 200 OK - успешная регистрация
  4. Установление звонка (INVITE):
    - Формирование SDP (Session Description Protocol) с
  параметрами медиа-сессии
    - Отправка INVITE с указанием кодеков (PCMU/PCMA), RTP
   портов
    - Получение 100 Trying, затем 180 Ringing
    - Получение 200 OK с SDP ответом от абонента
    - Отправка ACK для подтверждения

  Учетные данные:
  - SIP логин: 883140776920289
  - SIP домен: sip.exolve.ru
  - Пароль для Digest авторизации

  Вариант B: HTTP API (альтернативный)

  Процесс подключения:
  1. Авторизация - Bearer токен в заголовках HTTP запросов
  2. Инициация звонка:
  POST https://api.exolve.ru/call/v1/MakeCall
  {
    "source": "79587338190",
    "destination": "+7XXXXXXXXXX"
  }
  3. Получение external_id для отслеживания звонка
  4. Обработка вебхуков на /webhooks/exolve/callback для
  событий звонка

  2. Подключение к ElevenLabs AI

  WebSocket соединение:

  1. URL формирование:
  wss://api.elevenlabs.io/v1/convai/conversation?agent_id=
  {AGENT_ID}
  2. Авторизация:
    - Заголовок xi-api-key с API ключом ElevenLabs
  3. Прокси поддержка (опционально):
    - SOCKS5 прокси через aiohttp-socks
    - Авторизация в прокси если требуется
  4. Инициализация разговора:
  {
    "type": "conversation_initiation",
    "agent_id": "...",
    "conversation_config_override": {
      "tts": {
        "output_format": "ulaw_8000"  // μ-law 8kHz для 
  телефонии
      },
      "stt": {
        "input_format": "ulaw_8000"   // Формат входящего 
  аудио
      },
      "audio": {
        "chunk_size": 800,             // 100мс чанки при 
  8kHz
        "buffer_size": 100
      },
      "vad": {                        // Voice Activity 
  Detection
        "enabled": true,
        "threshold": 0.5,
        "silence_duration_ms": 700
      },
      "first_message": "Здравствуйте! Я AI ассистент. Чем 
  могу помочь?"
    }
  }
  5. Получение метаданных:
    - conversation_id - идентификатор сессии
    - Подтверждение форматов аудио
  6. Обмен сообщениями:
    - Отправка аудио от абонента:
    {
    "type": "user_audio_chunk",
    "audio": "<base64_encoded_audio>"
  }
    - Получение ответов AI:
        - agent_response - текстовый ответ
      - audio - синтезированная речь в base64
      - user_transcript - распознанная речь пользователя

  3. Аудио-мост (RTP ↔ WebSocket)

  Синхронизация потоков:
  1. RTP → WebSocket:
    - Получение RTP пакетов на UDP порт (10000-20000)
    - Извлечение payload (μ-law аудио)
    - Буферизация для сглаживания джиттера
    - Отправка в WebSocket каждые 100мс
  2. WebSocket → RTP:
    - Получение base64 аудио от AI
    - Декодирование и пакетизация в RTP
    - Установка sequence numbers и timestamps
    - Отправка с правильным pacing (20мс интервалы)

  NAT Traversal:
  - Отправка keep-alive пакетов для поддержания NAT сессии
  - Ожидание первого RTP пакета от удаленной стороны для
  определения реального адреса

  4. Мониторинг соединений

  - Статистика пакетов (отправленных/полученных)
  - Обнаружение разрыва соединения
  - Автоматическое завершение при получении SIP BYE
  - Логирование всех этапов подключения