# Voice AI System Architecture

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

```
[Phone] ‚Üê‚Üí [Baresip SIP] ‚Üê‚Üí [Audio Bridge] ‚Üê‚Üí [ElevenLabs AI]
                ‚Üì
          [TCP Events]
                ‚Üì
         [CallService]
```

## –ü–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π

### 1. –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
1. API –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å `POST /api/calls/dial`
2. CallService –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `dial` –≤ Baresip —á–µ—Ä–µ–∑ TCP
3. CallService –∑–∞–ø—É—Å–∫–∞–µ—Ç `_monitor_call_events()` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ SIP —Å–æ–±—ã—Ç–∏–π
4. Baresip –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç SIP –∑–≤–æ–Ω–æ–∫

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ SIP —Å–æ–±—ã—Ç–∏–π

–°–æ–±—ã—Ç–∏—è –æ—Ç Baresip –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ TCP –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

- **CALL_OUTGOING** - –∑–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω
- **CALL_RINGING** - —Ç–µ–ª–µ—Ñ–æ–Ω –∑–≤–æ–Ω–∏—Ç  
- **CALL_PROGRESS (SIP 183)** - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/–∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫
  - ‚ùå WebSocket –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è (—ç–∫–æ–Ω–æ–º–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤)
- **CALL_ESTABLISHED (SIP 200)** - —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –æ—Ç–≤–µ—Ç–∏–ª
  - ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –°–†–ê–ó–£
- **CALL_CLOSED** - –∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω
  - üîå WebSocket –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è

### 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WebSocket

WebSocket –∫ ElevenLabs –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞:

```python
# –í CallService._monitor_call_events():
if event_type == 'CALL_ESTABLISHED':  # SIP 200 OK
    # –°–æ–∑–¥–∞—ë–º —Å–∏–≥–Ω–∞–ª –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    with open("/tmp/connect_websocket", "w") as f:
        f.write(str(call_id))
        
elif event_type == 'CALL_PROGRESS':  # SIP 183
    # –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket - —ç—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä
    pass
```

Audio Bridge –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `/tmp/connect_websocket` - –ø–æ–¥–∫–ª—é—á–∏—Ç—å WebSocket
- `/tmp/disconnect_websocket` - –æ—Ç–∫–ª—é—á–∏—Ç—å WebSocket

## –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. **–ü—Ä—è–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ TCP** - CallService –Ω–∞–ø—Ä—è–º—É—é —á–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç Baresip
2. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** - –æ—Ç–¥–µ–ª—å–Ω–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏–π
3. **–°–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã** - –ø—Ä–æ—Å—Ç–∞—è –º–µ–∂–ø—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è
4. **–≠–∫–æ–Ω–æ–º–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤** - WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ

### ‚ùå –ß—Ç–æ –±—ã–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
1. ~~HTTP polling —á–µ—Ä–µ–∑ SIPCallMonitor~~ - —Å–æ–∑–¥–∞–≤–∞–ª —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
2. ~~–¢–∞–π–º–µ—Ä 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è~~ - –Ω–µ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–ª –º–æ–º–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞
3. ~~–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–æ–Ω–∏—Ç–æ—Ä–æ–≤~~ - –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

## Baresip TCP Protocol

### Netstring —Ñ–æ—Ä–º–∞—Ç
```
–¥–ª–∏–Ω–∞:–¥–∞–Ω–Ω—ã–µ,
```
- `–¥–ª–∏–Ω–∞` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ë–ê–ô–¢–û–í (–Ω–µ —Å–∏–º–≤–æ–ª–æ–≤!)
- `–¥–∞–Ω–Ω—ã–µ` - JSON –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ
- `,` - –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Å–∏–º–≤–æ–ª

### –ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã:
```python
cmd = {"command": "dial", "params": "79123456789"}
json_str = '{"command":"dial","params":"79123456789"}'
bytes = b'{"command":"dial","params":"79123456789"}'  # 42 –±–∞–π—Ç–∞
netstring = b'42:{"command":"dial","params":"79123456789"},'
```

### –ü—Ä–∏–º–µ—Ä —Å–æ–±—ã—Ç–∏—è:
```
50:{"event":true,"type":"CALL_ESTABLISHED","param":""},
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. BaresipController
- –£–ø—Ä–∞–≤–ª—è–µ—Ç Baresip —á–µ—Ä–µ–∑ TCP (–ø–æ—Ä—Ç 4444)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ netstring —Ñ–æ—Ä–º–∞—Ç–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Å–æ–±—ã—Ç–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏

### 2. CallService  
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç SIP —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ `_monitor_call_events()`
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º WebSocket —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

### 3. AudioBridge
- –ú–æ—Å—Ç –º–µ–∂–¥—É Baresip –∏ ElevenLabs
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (`run_audio_bridge.py`)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WebSocket

### 4. ElevenLabsClient
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ElevenLabs Conversational AI
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ SIP 200 OK
- –û—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞

## –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

1. **Terminal 1 - Audio Bridge:**
```bash
python run_audio_bridge.py
```

2. **Terminal 2 - Baresip:**
```bash
baresip -f .baresip
```

3. **Terminal 3 - API Server:**
```bash
python main.py
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–≠–∫–æ–Ω–æ–º–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ ElevenLabs:**
   - WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ (SIP 200)
   - –ò–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (SIP 183)
   - WebSocket –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –ù–µ—Ç HTTP polling - —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ TCP —Å–æ–±—ã—Ç–∏—è
   - –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–≤–µ—Ç–æ–º –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º AI

3. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:**
   - –û—Ç–¥–µ–ª—å–Ω—ã–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –¢–∞–π–º–∞—É—Ç—ã –Ω–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤