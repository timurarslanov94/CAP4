# CAP4 - ะัะบะพะฒะพะดััะฒะพ ัะฐะทัะฐะฑะพััะธะบะฐ

## ๐ ะะณะปะฐะฒะปะตะฝะธะต
1. [ะะฑะทะพั ะฟัะพะตะบัะฐ](#ะพะฑะทะพั-ะฟัะพะตะบัะฐ)
2. [ะััะธัะตะบัััะฐ ัะธััะตะผั](#ะฐััะธัะตะบัััะฐ-ัะธััะตะผั)
3. [ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั](#ะพัะฝะพะฒะฝัะต-ะบะพะผะฟะพะฝะตะฝัั)
4. [ะะพะฝัะธะณััะฐัะธั](#ะบะพะฝัะธะณััะฐัะธั)
5. [ะะฐะฟััะบ ัะธััะตะผั](#ะทะฐะฟััะบ-ัะธััะตะผั)
6. [API Endpoints](#api-endpoints)
7. [ะะพัะพะบ ะพะฑัะฐะฑะพัะบะธ ะทะฒะพะฝะบะฐ](#ะฟะพัะพะบ-ะพะฑัะฐะฑะพัะบะธ-ะทะฒะพะฝะบะฐ)
8. [ะัะพัะพะบะพะปั ะธ ัะพัะผะฐัั](#ะฟัะพัะพะบะพะปั-ะธ-ัะพัะผะฐัั)
9. [ะัะปะฐะดะบะฐ ะธ ะผะพะฝะธัะพัะธะฝะณ](#ะพัะปะฐะดะบะฐ-ะธ-ะผะพะฝะธัะพัะธะฝะณ)
10. [ะะฐััะธัะตะฝะธะต ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ](#ัะฐััะธัะตะฝะธะต-ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ)

---

## ๐ฏ ะะฑะทะพั ะฟัะพะตะบัะฐ

**CAP4** - ััะพ ัะธััะตะผะฐ ะธะฝัะตะณัะฐัะธะธ SIP ัะตะปะตัะพะฝะธะธ ั AI ะณะพะปะพัะพะฒัะผ ะฐััะธััะตะฝัะพะผ. ะัะพะตะบั ะฟะพะทะฒะพะปัะตั:
- ะกะพะฒะตััะฐัั ะธััะพะดััะธะต ะทะฒะพะฝะบะธ ัะตัะตะท SIP ะฟัะพัะพะบะพะป
- ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปััั, ะพัะฒะตัะธะป ะปะธ ัะตะฐะปัะฝัะน ัะตะปะพะฒะตะบ ะธะปะธ ะฐะฒัะพะพัะฒะตััะธะบ
- ะะพะดะบะปััะฐัั AI ะฐััะธััะตะฝัะฐ (ElevenLabs) ัะพะปัะบะพ ะฟัะธ ัะตะฐะปัะฝะพะผ ะพัะฒะตัะต
- ะะฑัะฐะฑะฐััะฒะฐัั ะฐัะดะธะพะฟะพัะพะบะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- ะญะบะพะฝะพะผะธัั ะบัะตะดะธัั AI ัะตัะฒะธัะฐ

### ะะปััะตะฒัะต ัะตัะฝะพะปะพะณะธะธ:
- **Python 3.13** - ะพัะฝะพะฒะฝะพะน ัะทัะบ
- **FastAPI** - REST API ะธ ะฐัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ
- **Baresip** - SIP ะบะปะธะตะฝั ะดะปั ัะตะปะตัะพะฝะธะธ
- **ElevenLabs Conversational AI** - ะณะตะฝะตัะฐัะธั ะธ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ัะตัะธ
- **WebSockets** - ะฟะตัะตะดะฐัะฐ ะฐัะดะธะพ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- **Dishka** - Dependency Injection ะบะพะฝัะตะนะฝะตั
- **UV** - ัะพะฒัะตะผะตะฝะฝัะน ะผะตะฝะตะดะถะตั ะฟะฐะบะตัะพะฒ Python

---

## ๐๏ธ ะััะธัะตะบัััะฐ ัะธััะตะผั

### ะััะพะบะพััะพะฒะฝะตะฒะฐั ััะตะผะฐ:

```
โโโโโโโโโโโโโโโ     SIP/RTP      โโโโโโโโโโโโโโโโ     Audio      โโโโโโโโโโโโโโโโโโโ
โ   ะขะตะปะตัะพะฝ   โ โโโโโโโโโโโโโโโโบ โ   Baresip    โ โโโโโโโโโโโโโโบ โ  Audio Bridge   โ
โโโโโโโโโโโโโโโ                  โโโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโโโโโ
                                         โ                                โ
                                    TCP Events                       WebSocket
                                         โ                                โ
                                         โผ                                โผ
                                  โโโโโโโโโโโโโโโโ                โโโโโโโโโโโโโโโโโโโ
                                  โ CallService  โ                โ  ElevenLabs AI  โ
                                  โโโโโโโโโโโโโโโโ                โโโโโโโโโโโโโโโโโโโ
                                         โ
                                    REST API
                                         โ
                                         โผ
                                  โโโโโโโโโโโโโโโโ
                                  โ   FastAPI    โ
                                  โโโโโโโโโโโโโโโโ
```

### ะกะปะพะตะฒะฐั ะฐััะธัะตะบัััะฐ:

```
โโโ API Layer (FastAPI endpoints)
โ   โโโ src/api/
โ       โโโ app.py           # FastAPI ะฟัะธะปะพะถะตะฝะธะต
โ       โโโ routers/         # REST endpoints
โ
โโโ Service Layer (ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ)
โ   โโโ src/services/
โ       โโโ call_service.py  # ะฃะฟัะฐะฒะปะตะฝะธะต ะทะฒะพะฝะบะฐะผะธ
โ       โโโ call_monitor.py  # ะะพะฝะธัะพัะธะฝะณ ัะพะฑััะธะน
โ
โโโ Infrastructure Layer
โ   โโโ src/infrastructure/
โ       โโโ telephony/       # SIP ะธะฝัะตะณัะฐัะธั
โ       โโโ audio/           # ะัะดะธะพ ะพะฑัะฐะฑะพัะบะฐ
โ       โโโ ai/              # AI ะธะฝัะตะณัะฐัะธั
โ
โโโ Domain Layer
โ   โโโ src/models/          # ะะพะดะตะปะธ ะดะฐะฝะฝัั
โ
โโโ Core
    โโโ src/core/
        โโโ config.py        # ะะพะฝัะธะณััะฐัะธั
        โโโ di.py            # Dependency Injection
```

---

## ๐ง ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. **CallService** (`src/services/call_service.py`)
**ะะฐะทะฝะฐัะตะฝะธะต**: ะฆะตะฝััะฐะปัะฝัะน ัะตัะฒะธั ัะฟัะฐะฒะปะตะฝะธั ะทะฒะพะฝะบะฐะผะธ

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ**:
- `start_call()` - ะธะฝะธัะธะธััะตั ะธััะพะดััะธะน ะทะฒะพะฝะพะบ
- `_monitor_call_events()` - ะผะพะฝะธัะพัะธั SIP ัะพะฑััะธั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- `connect_elevenlabs()` - ะฟะพะดะบะปััะฐะตั AI ะฟัะธ ะพัะฒะตัะต ัะตะปะพะฒะตะบะฐ
- `end_call()` - ะทะฐะฒะตััะฐะตั ะทะฒะพะฝะพะบ

**ะะปััะตะฒะฐั ะปะพะณะธะบะฐ**:
```python
# ะะฟัะตะดะตะปะตะฝะธะต ัะธะฟะฐ ะพัะฒะตัะฐ:
if event_type == 'CALL_ESTABLISHED':  # SIP 200 OK
    # ะะตะฐะปัะฝัะน ัะตะปะพะฒะตะบ - ะฟะพะดะบะปััะฐะตะผ AI
    create_signal("/tmp/connect_websocket")
    
elif event_type == 'CALL_PROGRESS':  # SIP 183
    # ะะฒัะพะพัะฒะตััะธะบ - ะะ ะฟะพะดะบะปััะฐะตะผ AI
    pass
```

### 2. **BaresipController** (`src/infrastructure/telephony/baresip_controller.py`)
**ะะฐะทะฝะฐัะตะฝะธะต**: ะฃะฟัะฐะฒะปะตะฝะธะต SIP ะบะปะธะตะฝัะพะผ Baresip

**ะัะพัะพะบะพะป**: TCP ะฝะฐ ะฟะพััั 4444, ัะพัะผะฐั Netstring
**ะัะฝะพะฒะฝัะต ะบะพะผะฐะฝะดั**:
- `dial` - ัะพะฒะตััะธัั ะทะฒะพะฝะพะบ
- `hangup` - ะทะฐะฒะตััะธัั ะทะฒะพะฝะพะบ
- `accept` - ะฟัะธะฝััั ะฒัะพะดััะธะน

**ะคะพัะผะฐั Netstring**:
```
ะดะปะธะฝะฐ:{"command":"dial","params":"79123456789"},
```

### 3. **AudioBridge** (`src/infrastructure/audio/audio_bridge.py`)
**ะะฐะทะฝะฐัะตะฝะธะต**: ะะพัั ะผะตะถะดั ัะตะปะตัะพะฝะธะตะน ะธ AI

**ะคัะฝะบัะธะธ**:
- ะะฐัะฒะฐั ะฐัะดะธะพ ะพั Baresip (8kHz, ยต-law)
- ะะพะฝะฒะตััะฐัะธั ัะพัะผะฐัะพะฒ (8kHz โ 16kHz)
- ะะตัะตะดะฐัะฐ ะฒ ElevenLabs WebSocket
- ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะพัะฒะตัะพะฒ AI

**ะัะดะธะพ ััััะพะนััะฒะฐ**:
- Input: `Baresip-RemoteAudio` (ะพั ัะตะปะตัะพะฝะฐ)
- Output: `Baresip-CallInput` (ะบ ัะตะปะตัะพะฝั)

### 4. **ElevenLabsClient** (`src/infrastructure/ai/elevenlabs_client.py`)
**ะะฐะทะฝะฐัะตะฝะธะต**: WebSocket ะบะปะธะตะฝั ะดะปั AI ัะตัะฒะธัะฐ

**ะัะพัะพะบะพะป**: WebSocket ั JSON ัะพะฑััะธัะผะธ
**ะคะพัะผะฐัั ะฐัะดะธะพ**:
- Input: PCM 16kHz
- Output: ยต-law 8kHz

**ะกะพะฑััะธั**:
- `conversation_initiation` - ะธะฝะธัะธะฐะปะธะทะฐัะธั
- `audio` - ะฐัะดะธะพะดะฐะฝะฝัะต
- `user_transcript` - ัะฐัะฟะพะทะฝะฐะฝะฝัะน ัะตะบัั ะฟะพะปัะทะพะฒะฐัะตะปั
- `agent_response` - ะพัะฒะตั AI

### 5. **Audio Bridge Process** (`run_audio_bridge.py`)
**ะะฐะทะฝะฐัะตะฝะธะต**: ะัะดะตะปัะฝัะน ะฟัะพัะตัั ะดะปั ะพะฑัะฐะฑะพัะบะธ ะฐัะดะธะพ

**ะัะพะฑะตะฝะฝะพััะธ**:
- ะะฐะฑะพัะฐะตั ะฝะตะทะฐะฒะธัะธะผะพ ะพั ะพัะฝะพะฒะฝะพะณะพ API
- ะะพะฝะธัะพัะธั ัะธะณะฝะฐะปัะฝัะต ัะฐะนะปั
- ะฃะฟัะฐะฒะปัะตั WebSocket ัะพะตะดะธะฝะตะฝะธะตะผ

**ะกะธะณะฝะฐะปั**:
- `/tmp/connect_websocket` - ะฟะพะดะบะปััะธัั AI
- `/tmp/disconnect_websocket` - ะพัะบะปััะธัั AI

---

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั (`.env`):

```bash
# Exolve SIP ัะตะปะตัะพะฝะธั
EXOLVE_API_KEY=<ะฒะฐั_api_ะบะปัั>
EXOLVE_SIP_USER=<sip_ะปะพะณะธะฝ>
EXOLVE_SIP_PASS=<sip_ะฟะฐัะพะปั>
EXOLVE_SIP_DOMAIN=sip.exolve.ru

# ElevenLabs AI
ELEVENLABS_API_KEY=<api_ะบะปัั>
ELEVENLABS_AGENT_ID=<id_ะฐะณะตะฝัะฐ>

# Baresip
BARESIP_HOST=localhost
BARESIP_CTRL_TCP_PORT=4444

# ะัะธะปะพะถะตะฝะธะต
APP_HOST=0.0.0.0
APP_PORT=8000
APP_DEBUG=false
APP_LOG_LEVEL=INFO
```

### ะะพะฝัะธะณััะฐัะธั Baresip (`config/baresip/config`):

```
# ะัะฝะพะฒะฝัะต ะผะพะดัะปะธ
module          aubridge.so      # ะัะดะธะพ ะผะพัั
module          ctrl_tcp.so      # TCP ัะฟัะฐะฒะปะตะฝะธะต

# TCP ะบะพะฝััะพะปั
ctrl_tcp_listen 0.0.0.0:4444

# ะัะดะธะพ ะบะพะดะตะบะธ
audio_codec     PCMU/8000/1     # G.711 ยต-law
```

---

## ๐ ะะฐะฟััะบ ัะธััะตะผั

### ะขัะตะฑะพะฒะฐะฝะธั:
- Python 3.13+
- Baresip ั ะผะพะดัะปัะผะธ aubridge ะธ ctrl_tcp
- ะะธัััะฐะปัะฝัะต ะฐัะดะธะพ ััััะพะนััะฒะฐ (BlackHole ะฝะฐ macOS)

### ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั ะทะฐะฟััะบะฐ:

#### Terminal 1 - Audio Bridge:
```bash
python run_audio_bridge.py
```
ะะฐะฟััะบะฐะตั ะฐัะดะธะพ ะผะพัั ะธ WebSocket ะผะตะฝะตะดะถะตั.

#### Terminal 2 - Baresip:
```bash
baresip -f config/baresip
```
ะะฐะฟััะบะฐะตั SIP ะบะปะธะตะฝั.

#### Terminal 3 - API Server:
```bash
python src/main.py
```
ะะฐะฟััะบะฐะตั FastAPI ัะตัะฒะตั ะฝะฐ ะฟะพััั 8000.

### ะะปััะตัะฝะฐัะธะฒะฝัะน ะทะฐะฟััะบ:
```bash
# ะัะต ะบะพะผะฟะพะฝะตะฝัั ะพะดะฝะพะน ะบะพะผะฐะฝะดะพะน
./start_full_system.sh
```

---

## ๐ก API Endpoints

### POST `/api/calls/dial`
ะะฝะธัะธะธััะตั ะธััะพะดััะธะน ะทะฒะพะฝะพะบ.

**Request:**
```json
{
  "phone_number": "79123456789"
}
```

**Response:**
```json
{
  "id": "uuid",
  "phone_number": "79123456789",
  "status": "dialing",
  "direction": "outbound",
  "started_at": "2024-01-20T10:00:00Z"
}
```

### GET `/api/calls/{call_id}`
ะะพะปััะฐะตั ะธะฝัะพัะผะฐัะธั ะพ ะทะฒะพะฝะบะต.

### POST `/api/calls/{call_id}/hangup`
ะะฐะฒะตััะฐะตั ะฐะบัะธะฒะฝัะน ะทะฒะพะฝะพะบ.

### GET `/api/calls`
ะกะฟะธัะพะบ ะฒัะตั ะทะฒะพะฝะบะพะฒ.

---

## ๐ ะะพัะพะบ ะพะฑัะฐะฑะพัะบะธ ะทะฒะพะฝะบะฐ

### 1. ะะฝะธัะธะฐัะธั ะทะฒะพะฝะบะฐ:
```
Client โ POST /api/calls/dial
  โ CallService.start_call()
    โ BaresipController.dial()
      โ Baresip ัะพะฒะตััะฐะตั SIP INVITE
```

### 2. ะะพะฝะธัะพัะธะฝะณ ัะพะฑััะธะน:
```
CallService._monitor_call_events()
  โ BaresipController.monitor_call_events()
    โ TCP ะฟะพัะพะบ ัะพะฑััะธะน ะพั Baresip
      โ Callback ะพะฑัะฐะฑะพัะบะฐ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
```

### 3. ะะฟัะตะดะตะปะตะฝะธะต ัะธะฟะฐ ะพัะฒะตัะฐ:

#### ะะฒัะพะพัะฒะตััะธะบ (SIP 183):
```
CALL_PROGRESS โ 
  ะะพะณะธัะพะฒะฐะฝะธะต "Operator message" โ
    WebSocket ะะ ะฟะพะดะบะปััะฐะตััั
```

#### ะะตะฐะปัะฝัะน ัะตะปะพะฒะตะบ (SIP 200):
```
CALL_ESTABLISHED โ 
  create("/tmp/connect_websocket") โ
    AudioBridge ะฒะธะดะธั ัะธะณะฝะฐะป โ
      ElevenLabsClient.connect() โ
        WebSocket ะฐะบัะธะฒะตะฝ
```

### 4. ะะฑัะฐะฑะพัะบะฐ ะฐัะดะธะพ:
```
ะขะตะปะตัะพะฝ โ Baresip โ 
  Baresip-RemoteAudio (ะฒะธัััะฐะปัะฝะพะต ััััะพะนััะฒะพ) โ
    AudioBridge.capture() โ
      ะะพะฝะฒะตััะฐัะธั 8kHz โ 16kHz โ
        WebSocket โ ElevenLabs

ElevenLabs โ WebSocket โ
  AudioBridge.receive() โ
    ะะพะฝะฒะตััะฐัะธั 16kHz โ 8kHz โ
      Baresip-CallInput โ
        Baresip โ ะขะตะปะตัะพะฝ
```

### 5. ะะฐะฒะตััะตะฝะธะต:
```
CALL_CLOSED event โ
  create("/tmp/disconnect_websocket") โ
    WebSocket ะพัะบะปััะฐะตััั โ
      ะัะฒะพะฑะพะถะดะตะฝะธะต ัะตััััะพะฒ
```

---

## ๐ ะัะพัะพะบะพะปั ะธ ัะพัะผะฐัั

### Baresip TCP Protocol (Netstring):
```python
# ะคะพัะผะฐั: ะดะปะธะฝะฐ:ะดะฐะฝะฝัะต,
def encode_netstring(data: dict) -> bytes:
    json_str = json.dumps(data)
    json_bytes = json_str.encode('utf-8')
    length = len(json_bytes)
    return f"{length}:{json_str},".encode('utf-8')

# ะัะธะผะตั ะบะพะผะฐะฝะดั:
{"command": "dial", "params": "79123456789"}
# ะะฐะบะพะดะธัะพะฒะฐะฝะพ: 42:{"command":"dial","params":"79123456789"},
```

### ElevenLabs WebSocket Protocol:
```javascript
// ะัะฟัะฐะฒะบะฐ ะฐัะดะธะพ
{
  "type": "input_audio_buffer.append",
  "audio": "base64_encoded_pcm"
}

// ะะพะปััะตะฝะธะต ะฐัะดะธะพ
{
  "type": "audio",
  "audio": {
    "chunk": "base64_encoded_ulaw"
  }
}

// ะขัะฐะฝัะบัะธะฟัะธั
{
  "type": "user_transcript",
  "transcript": "ะัะธะฒะตั, ะบะฐะบ ะดะตะปะฐ?"
}
```

### SIP ัะพะฑััะธั ะพั Baresip:
```python
# ะะปััะตะฒัะต ัะพะฑััะธั ะดะปั ะปะพะณะธะบะธ:
CALL_OUTGOING    # ะะฒะพะฝะพะบ ะธะฝะธัะธะธัะพะฒะฐะฝ
CALL_RINGING     # ะขะตะปะตัะพะฝ ะทะฒะพะฝะธั
CALL_PROGRESS    # SIP 183 - ะฐะฒัะพะพัะฒะตััะธะบ/ะพะฟะตัะฐัะพั
CALL_ESTABLISHED # SIP 200 - ัะตะฐะปัะฝัะน ะพัะฒะตั
CALL_CLOSED      # ะะฒะพะฝะพะบ ะทะฐะฒะตัััะฝ
```

---

## ๐ ะัะปะฐะดะบะฐ ะธ ะผะพะฝะธัะพัะธะฝะณ

### ะะพะณะธัะพะฒะฐะฝะธะต:
```python
# ะะฐัััะพะนะบะฐ ะฒ main.py
structlog.configure(
    processors=[
        structlog.dev.ConsoleRenderer()  # ะฆะฒะตัะฝะพะน ะฒัะฒะพะด
    ]
)

# ะัะฟะพะปัะทะพะฒะฐะฝะธะต:
logger = structlog.get_logger()
await logger.ainfo("Call started", call_id=call_id)
```

### ะะพะฝะธัะพัะธะฝะณ Audio Bridge:
```bash
# ะะพะณะธ ะฐัะดะธะพ ะผะพััะฐ
tail -f logs/audio_bridge.log

# ะัะพะฒะตัะบะฐ ัะธะณะฝะฐะปะพะฒ
watch -n 1 'ls -la /tmp/*websocket*'
```

### ะัะปะฐะดะบะฐ Baresip:
```bash
# ะะฝัะตัะฐะบัะธะฒะฝะฐั ะบะพะฝัะพะปั Baresip
# ะะฐะถะผะธัะต 'h' ะดะปั ัะฟัะฐะฒะบะธ
# 'd' - ัะพะฒะตััะธัั ะทะฒะพะฝะพะบ
# 'b' - ะทะฐะฒะตััะธัั ะทะฒะพะฝะพะบ
```

### ะขะตััะธัะพะฒะฐะฝะธะต WebSocket:
```python
# debug_simple.py - ะฟัะพััะพะน ัะตััะพะฒัะน ะบะปะธะตะฝั
python debug_simple.py
```

---

## ๐จ ะะฐััะธัะตะฝะธะต ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะณะพ AI ะฟัะพะฒะฐะนะดะตัะฐ:

1. ะกะพะทะดะฐัั ะบะปะธะตะฝั ะฒ `src/infrastructure/ai/`:
```python
class NewAIClient:
    async def connect(self) -> None: ...
    async def send_audio(self, frame: AudioFrame) -> None: ...
    async def disconnect(self) -> None: ...
```

2. ะะฐัะตะณะธัััะธัะพะฒะฐัั ะฒ DI ะบะพะฝัะตะนะฝะตัะต:
```python
# src/infrastructure/di/infrastructure_provider.py
@provide(scope=Scope.APP)
async def new_ai_client(config: Settings) -> NewAIClient:
    return NewAIClient(config)
```

3. ะะฑะฝะพะฒะธัั CallService ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฝะพะฒะพะณะพ ะบะปะธะตะฝัะฐ.

### ะะพะฑะฐะฒะปะตะฝะธะต ะฒัะพะดััะธั ะทะฒะพะฝะบะพะฒ:

1. ะะพะฑะฐะฒะธัั endpoint ะฒ `src/api/routers/calls.py`:
```python
@router.post("/answer")
async def answer_call(call_service: FromDishka[CallService]):
    return await call_service.answer_incoming()
```

2. ะะตะฐะปะธะทะพะฒะฐัั ะปะพะณะธะบั ะฒ CallService:
```python
async def answer_incoming(self) -> Call:
    await self.baresip.send_command(BaresipCommand.ANSWER)
    # ะะพะณะธะบะฐ ะพะฑัะฐะฑะพัะบะธ ะฒัะพะดััะตะณะพ
```

### ะะพะฑะฐะฒะปะตะฝะธะต ะทะฐะฟะธัะธ ะทะฒะพะฝะบะพะฒ:

1. ะกะพะทะดะฐัั ัะตัะฒะธั ะทะฐะฟะธัะธ:
```python
class RecordingService:
    def start_recording(self, call_id: UUID): ...
    def stop_recording(self, call_id: UUID): ...
```

2. ะะฝัะตะณัะธัะพะฒะฐัั ะฒ AudioBridge:
```python
if self.recording_enabled:
    self.recording_service.write_frame(frame)
```

---

## ๐ ะะพะปะตะทะฝัะต ัััะปะบะธ

- [Baresip Documentation](https://github.com/baresip/baresip)
- [ElevenLabs API Docs](https://elevenlabs.io/docs/conversational-ai)
- [FastAPI Documentation](https://fastapi.tiangolo.com)
- [Dishka DI Framework](https://github.com/reagento/dishka)

---

## โ๏ธ ะะฐะถะฝัะต ะผะพะผะตะฝัั

1. **ะญะบะพะฝะพะผะธั ะบัะตะดะธัะพะฒ**: WebSocket ะบ ElevenLabs ะฟะพะดะบะปััะฐะตััั ะขะะะฌะะ ะฟัะธ SIP 200 (ัะตะฐะปัะฝัะน ะพัะฒะตั), ะธะณะฝะพัะธััั SIP 183 (ะฐะฒัะพะพัะฒะตััะธะบะธ).

2. **ะัะธะฝััะพะฝะฝะพััั**: ะะตัั ะบะพะด ะฐัะธะฝััะพะฝะฝัะน, ะธัะฟะพะปัะทัะนัะต `async/await` ะฒะตะทะดะต.

3. **ะะฐะทะดะตะปะตะฝะธะต ะฟัะพัะตััะพะฒ**: Audio Bridge ัะฐะฑะพัะฐะตั ะพัะดะตะปัะฝัะผ ะฟัะพัะตััะพะผ ะดะปั ะธะทะพะปััะธะธ ะฐัะดะธะพ ะพะฑัะฐะฑะพัะบะธ.

4. **ะกะธะณะฝะฐะปัะฝัะต ัะฐะนะปั**: ะะตะถะฟัะพัะตััะฝะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ัะตัะตะท ัะฐะนะปั `/tmp/*websocket`.

5. **Netstring ะฟัะพัะพะบะพะป**: ะัะต ะบะพะผะฐะฝะดั ะบ Baresip ะดะพะปะถะฝั ะฑััั ะฒ ัะพัะผะฐัะต Netstring ั ะบะพััะตะบัะฝัะผ ะฟะพะดััััะพะผ ะฑะฐะนัะพะฒ.

6. **ะะธัััะฐะปัะฝัะต ััััะพะนััะฒะฐ**: ะขัะตะฑััััั ะฒะธัััะฐะปัะฝัะต ะฐัะดะธะพ ััััะพะนััะฒะฐ (BlackHole ะฝะฐ macOS, PulseAudio ะฝะฐ Linux).

---

## ๐ค ะะพะฝัะฐะบัั ะธ ะฟะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฒะพะฟัะพัะพะฒ ะพะฑัะฐัะฐะนัะตัั ะบ ะพัะฝะพะฒะฝะพะผั ัะฐะทัะฐะฑะพััะธะบั ะธะปะธ ัะพะทะดะฐะฒะฐะนัะต issue ะฒ ัะตะฟะพะทะธัะพัะธะธ ะฟัะพะตะบัะฐ.

---

*ะะพะบัะผะตะฝั ะพะฑะฝะพะฒะปัะฝ: ะฏะฝะฒะฐัั 2025*