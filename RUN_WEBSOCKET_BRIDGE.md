# ğŸ¯ Ğ—Ğ°Ğ¿ÑƒÑĞº Voice AI Agent Ñ WebSocket Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹

## âš¡ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚ (3 ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹)

```bash
# Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» 1: Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾ÑÑ‚Ğ°
./start_ai_bridge.sh

# Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» 2: Ğ—Ğ°Ğ¿ÑƒÑĞº Baresip
./start_baresip.sh

# Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» 3: Ğ—Ğ°Ğ¿ÑƒÑĞº API ÑĞµÑ€Ğ²ĞµÑ€Ğ°
make run
```

## ğŸ“‹ ĞŸĞ¾ÑˆĞ°Ğ³Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ

### 1ï¸âƒ£ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```bash
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ (Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·)
make init

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° .env Ñ„Ğ°Ğ¹Ğ»Ğ°
cat .env | grep ELEVENLABS
# Ğ”Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹:
# ELEVENLABS_API_KEY=...
# ELEVENLABS_AGENT_ID=...
```

### 2ï¸âƒ£ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ°ÑƒĞ´Ğ¸Ğ¾ pipes (Ğ’ĞĞ–ĞĞ: Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ”Ğ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Baresip!)

```bash
# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ named pipes
./setup_audio_pipes.sh

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ pipes ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹
ls -la /tmp/baresip_audio_*.pcm
# Ğ”Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ:
# prw-rw-rw-  /tmp/baresip_audio_in.pcm
# prw-rw-rw-  /tmp/baresip_audio_out.pcm
```

### 3ï¸âƒ£ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¼Ğ¾ÑÑ‚Ğ° (ĞŸĞ•Ğ Ğ’Ğ«Ğœ!)

```bash
# Ğ’ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğµ - Ğ¼Ğ¾ÑÑ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾
python run_audio_bridge.py

# Ğ’Ñ‹ ÑƒĞ²Ğ¸Ğ´Ğ¸Ñ‚Ğµ:
# âœ… Audio pipes connected
# ğŸŒ Connected to ElevenLabs WebSocket
# ğŸ‘‚ Listening for audio... (Ctrl+C to stop)
```

### 4ï¸âƒ£ Ğ—Ğ°Ğ¿ÑƒÑĞº Baresip Ñ pipe ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸ĞµĞ¹

```bash
# Ğ’ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğµ
./start_baresip_with_pipes.sh

# Ğ˜Ğ»Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:
baresip -f ~/.baresip_pipes

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸:
# Ğ’ ĞºĞ¾Ğ½ÑĞ¾Ğ»Ğ¸ baresip Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ: r
# Ğ”Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ: 883140776920289@sip.exolve.ru [OK]
```

### 5ï¸âƒ£ Ğ—Ğ°Ğ¿ÑƒÑĞº FastAPI ÑĞµÑ€Ğ²ĞµÑ€Ğ°

```bash
# Ğ’ Ñ‚Ñ€ĞµÑ‚ÑŒĞµĞ¼ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğµ
make run

# Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ğ½Ğ° http://localhost:8000
```

### 6ï¸âƒ£ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº

```bash
# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº Ñ‡ĞµÑ€ĞµĞ· API
curl -X POST http://localhost:8000/api/calls/start \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "+79273280718"}'

# Ğ˜Ğ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ:
open http://localhost:8000/docs
```

## ğŸ” ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ°

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ pipes:
```bash
# Ğ¡Ğ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚ Baresip
xxd /tmp/baresip_audio_out.pcm | head

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾ÑÑ‚ Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
tail -f logs/audio_bridge.log
```

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ:
```bash
# Ğ›Ğ¾Ğ³Ğ¸ Ğ¼Ğ¾ÑÑ‚Ğ° Ğ¿Ğ¾ĞºĞ°Ğ¶ÑƒÑ‚:
# [INFO] WebSocket: Sending audio chunk (640 bytes)
# [INFO] WebSocket: Received AI response (320 bytes)
```

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¼Ğ¾ÑÑ‚Ğ° (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10 ÑĞµĞº):
```
Audio bridge metrics:
  caller_to_ai: {packets: 500, bytes: 160000}
  ai_to_caller: {packets: 450, bytes: 144000}
  resampling_ops: 950
  errors: 0
```

## âš ï¸ Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ñ‹

1. **ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµĞ½:**
   - Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¼Ğ¾ÑÑ‚ (Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ĞµĞ»ÑŒ pipes)
   - ĞŸĞ¾Ñ‚Ğ¾Ğ¼ Baresip (Ğ¿Ğ¸ÑĞ°Ñ‚ĞµĞ»ÑŒ pipes)
   - ĞŸĞ¾Ñ‚Ğ¾Ğ¼ API ÑĞµÑ€Ğ²ĞµÑ€

2. **ĞĞµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¼Ğ¾ÑÑ‚ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ²Ğ¾Ğ½ĞºĞ°** - Baresip Ğ·Ğ°Ğ²Ğ¸ÑĞ½ĞµÑ‚!

3. **ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ "Broken pipe":**
   ```bash
   # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ
   killall baresip
   pkill -f run_audio_bridge
   ./setup_audio_pipes.sh  # ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ pipes
   # Ğ˜ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ñ ÑˆĞ°Ğ³Ğ° 3
   ```

## ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```bash
# ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸:
1. Ctrl+C Ğ² Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğµ Ñ API ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼
2. Ğ’ baresip: /quit
3. Ctrl+C Ğ² Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğµ Ñ Ğ¼Ğ¾ÑÑ‚Ğ¾Ğ¼

# Ğ˜Ğ»Ğ¸ Ğ²ÑÑ‘ ÑÑ€Ğ°Ğ·Ñƒ:
./stop_all.sh
```

## ğŸ“Š ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     8kHz PCM      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Caller    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Baresip    â”‚
â”‚  (Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½)  â”‚                   â”‚  (SIP/RTP)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ pipes
                                          â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Audio Bridge â”‚
                                  â”‚   (Python)   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                    resample 8â†’16kHz
                                          â”‚
                                          â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  WebSocket   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  ElevenLabs  â”‚
                                  â”‚   AI Agent   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› Troubleshooting

| ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° | Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ |
|----------|---------|
| "FIFO: No such file" | Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ `./setup_audio_pipes.sh` |
| "Baresip hangs on call" | Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾ÑÑ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ |
| "No audio in call" | ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ pipes Ğ² baresip |
| "WebSocket connection failed" | ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ELEVENLABS_API_KEY Ğ² .env |
| "High latency" | Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ¸Ñ‚ÑŒ chunk_size_ms Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ |

## ğŸ“ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

Ğ’ÑĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ² `.env` Ñ„Ğ°Ğ¹Ğ»Ğµ:
```bash
# Audio settings
AUDIO_CHUNK_SIZE_MS=20  # Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ñ‡Ğ°Ğ½ĞºĞ° (Ğ¼Ñ)

# ElevenLabs
ELEVENLABS_API_KEY=your_key_here
ELEVENLABS_AGENT_ID=your_agent_id
```

---

ğŸ’¡ **Ğ¡Ğ¾Ğ²ĞµÑ‚:** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ `tmux` Ğ¸Ğ»Ğ¸ `screen` Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ğ¼Ğ¸:
```bash
tmux new-session -s voiceai
# Ctrl+B, C - Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾
# Ctrl+B, 0-2 - Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¾ĞºĞ½Ğ°Ğ¼Ğ¸
```