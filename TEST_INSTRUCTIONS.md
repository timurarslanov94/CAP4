# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ **–£–±—Ä–∞–Ω –∏–∑–±—ã—Ç–æ—á–Ω—ã–π HTTP polling** - SIPCallMonitor –±–æ–ª—å—à–µ –Ω–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç `/api/calls` –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
2. ‚úÖ **–°–æ–±—ã—Ç–∏—è –º–æ–Ω–∏—Ç–æ—Ä—è—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ TCP** - CallService —á–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç Baresip –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. ‚úÖ **WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ SIP 200 OK** - —ç–∫–æ–Ω–æ–º–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ ElevenLabs

## –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä (Ctrl+C) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ
python main.py
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ –∑–∞–ø—É—Å–∫–µ SIPCallMonitor
- ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "API started - SIP events monitored directly via Baresip TCP"
- ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ "GET /api/calls"

### 2. –¢–µ—Å—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ SIP —Å–æ–±—ã—Ç–∏–π

```bash
python test_sip_events.py 79123456789
```

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞: –≤—ã —É–≤–∏–¥–∏—Ç–µ "üéâ CALL_ESTABLISHED (SIP 200 OK)"
- –ü—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: –≤—ã —É–≤–∏–¥–∏—Ç–µ "üì¢ CALL_PROGRESS (SIP 183)"

### 3. –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ API

```bash
# –°–¥–µ–ª–∞–π—Ç–µ –∑–≤–æ–Ω–æ–∫
curl -X POST http://localhost:8000/api/calls/dial \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "79123456789"}'
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å API:**
```
üì° Starting real-time monitoring for call <UUID>
‚è≥ Waiting for SIP events from Baresip...
   - SIP 183 (CALL_PROGRESS) = operator message ‚Üí NO WebSocket
   - SIP 200 (CALL_ESTABLISHED) = real answer ‚Üí CONNECT WebSocket
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å Audio Bridge:**
- –ü—Ä–∏ SIP 183: –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å
- –ü—Ä–∏ SIP 200: –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è "üéØ CALL ANSWERED! Connecting to ElevenLabs WebSocket..."

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–≤–æ–Ω–æ–∫ –Ω–∞ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞**
1. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä —Å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–æ–º
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ CALL_PROGRESS (SIP 183)
3. WebSocket –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è
4. –ö—Ä–µ–¥–∏—Ç—ã ElevenLabs –ù–ï –¥–æ–ª–∂–Ω—ã —Å–ø–∏—Å—ã–≤–∞—Ç—å—Å—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–≤–æ–Ω–æ–∫ —Å —Ä–µ–∞–ª—å–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º**
1. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä –≥–¥–µ –æ—Ç–≤–µ—Ç–∏—Ç —á–µ–ª–æ–≤–µ–∫
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å CALL_ESTABLISHED (SIP 200)
3. WebSocket –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –°–†–ê–ó–£ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
4. –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞ WebSocket –¥–æ–ª–∂–µ–Ω –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
tail -f main.log | grep "GET /api/calls"
```

–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤—ã –ù–ï –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —ç—Ç–æ–º—É endpoint.

## –ß–µ–∫-–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞

- [ ] API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ SIPCallMonitor
- [ ] –ù–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö GET –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ /api/calls
- [ ] SIP 183 (–æ–ø–µ—Ä–∞—Ç–æ—Ä) –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
- [ ] SIP 200 (—Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç) –°–†–ê–ó–£ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç WebSocket
- [ ] WebSocket –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞
- [ ] –ö—Ä–µ–¥–∏—Ç—ã ElevenLabs –Ω–µ —Ç—Ä–∞—Ç—è—Ç—Å—è –Ω–∞ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∏

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Audio Bridge –∑–∞–ø—É—â–µ–Ω (`python run_audio_bridge.py`)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `/tmp/connect_websocket` - –æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø—Ä–∏ SIP 200

2. **–í—Å—ë —Ä–∞–≤–Ω–æ –∏–¥—É—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ /api/calls:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/api/app.py` —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ —Å–∫—Ä–∏–ø—Ç—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã

3. **–°–æ–±—ã—Ç–∏—è –æ—Ç Baresip –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Baresip –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç 4444 - `telnet localhost 4444`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Baresip –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ