# Voice AI System - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ‚úÖ –ö–æ–º–∞–Ω–¥–∞ dial —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: `sip:number@domain`
2. ‚úÖ –£–±—Ä–∞–Ω –∏–∑–±—ã—Ç–æ—á–Ω—ã–π HTTP polling (SIPCallMonitor –æ—Ç–∫–ª—é—á—ë–Ω)
3. ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ (SIP 200)
4. ‚úÖ WebSocket –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞

## –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### Terminal 1 - Audio Bridge
```bash
python run_audio_bridge.py
# –∏–ª–∏
./start_ai_bridge.sh
```

### Terminal 2 - Baresip
```bash
baresip -f config/baresip
# –∏–ª–∏
./start_baresip.sh
```

### Terminal 3 - API Server
```bash
python main.py
```

## –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞

### –ß–µ—Ä–µ–∑ API:
```bash
curl -X POST http://localhost:8000/api/calls/start \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "+79123456789"}'
```

### –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000/docs

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### 1. –ü—Ä–∏ –∑–≤–æ–Ω–∫–µ –Ω–∞ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ (SIP 183):
```
üì¢ CALL_PROGRESS - SIP 183 Session Progress
   ‚Üí This is operator/voicemail message
   ‚Üí WebSocket should NOT be connected
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** WebSocket –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è, –∫—Ä–µ–¥–∏—Ç—ã ElevenLabs —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ

### 2. –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ (SIP 200):
```
üéâ CALL_ESTABLISHED - SIP 200 OK!
   ‚Üí Real person answered the phone
   ‚Üí WebSocket should be connected NOW
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –°–†–ê–ó–£ ‚úÖ

### 3. –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞:
```
üìµ Call ended: CALL_CLOSED
   ‚Üí WebSocket should be disconnected
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** WebSocket –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, —ç–∫–æ–Ω–æ–º–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ ‚úÖ

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤:
–í –ª–æ–≥–∞—Ö API –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö:
```
INFO: 127.0.0.1:xxxxx - "GET /api/calls HTTP/1.1" 200 OK
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–µ–∫—Ü–∏—é SIP —Å–æ–±—ã—Ç–∏–π:
```bash
python test_sip_events.py 79123456789
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã dial:
```bash
python test_baresip_dial.py 79123456789
```

## –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### `.env` - –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
```env
# ElevenLabs
ELEVENLABS_API_KEY=your_key
ELEVENLABS_AGENT_ID=your_agent_id

# Exolve
EXOLVE_SIP_USER=883140776920289
EXOLVE_SIP_PASS=your_password
EXOLVE_SIP_DOMAIN=sip.exolve.ru
```

### `config/baresip/accounts` - SIP –∞–∫–∫–∞—É–Ω—Ç:
```
<sip:883140776920289@sip.exolve.ru>;auth_user=883140776920289;auth_pass=pass;outbound="sip:80.75.130.100"
```

### `config/baresip/config` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Baresip:
```
ctrl_tcp_listen         0.0.0.0:4444
module                  ctrl_tcp.so
```

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é SIP –≤ –∫–æ–Ω—Å–æ–ª–∏ Baresip (–Ω–∞–∂–º–∏—Ç–µ 'r')
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω –≤ .env
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python test_baresip_dial.py` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ï—Å–ª–∏ WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Audio Bridge –∑–∞–ø—É—â–µ–Ω
2. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:
   ```bash
   rm -f /tmp/connect_websocket /tmp/disconnect_websocket
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Audio Bridge

### –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ GET –∑–∞–ø—Ä–æ—Å—ã:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `src/api/app.py` –æ—Ç–∫–ª—é—á—ë–Ω SIPCallMonitor

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞:
```bash
tail -f logs/api.log
```

### –õ–æ–≥–∏ Audio Bridge:
```bash
tail -f logs/audio_bridge.log
```

### –°–æ–±—ã—Ç–∏—è Baresip:
–°–º–æ—Ç—Ä–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ Baresip –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `test_sip_events.py`

## –≠–∫–æ–Ω–æ–º–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ ElevenLabs

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚ùå –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ—Ç WebSocket –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞—Ö (SIP 183)
- ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ—Ç WebSocket —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ (SIP 200)
- üìµ –û—Ç–∫–ª—é—á–∞–µ—Ç WebSocket —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å —Ç—Ä–∞—Ç –Ω–∞:
- –ì–æ–ª–æ—Å–æ–≤—ã–µ –º–µ–Ω—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- –°–æ–æ–±—â–µ–Ω–∏—è "–∞–±–æ–Ω–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
- –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∏ –∏ voicemail